<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DR-MITAMBO PRO | Professional OS{% endblock %}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --cat: #FFCD00; 
            --neon: #00ffcc;
            --bg: #050505; 
            --card: #111111; 
            --sidebar-w: 280px; 
        }
        
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Sidebar ya Kisasa */
        .sidebar { 
            position: fixed; left: calc(-1 * var(--sidebar-w)); width: var(--sidebar-w); 
            height: 100vh; background: #000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1100; border-right: 1px solid #222; overflow-y: auto;
        }
        .sidebar.active { left: 0; box-shadow: 10px 0 50px rgba(0,255,204,0.1); }
        
        .nav-link-pro { 
            color: #888; padding: 12px 20px; display: flex; align-items: center; 
            text-decoration: none; transition: 0.3s; margin: 4px 15px; border-radius: 12px;
            font-size: 0.9rem; font-weight: 500;
        }
        .nav-link-pro:hover, .nav-link-pro.active-page { 
            background: rgba(0, 255, 204, 0.05); 
            color: var(--neon); 
            border-left: 3px solid var(--neon);
        }
        .nav-link-pro i { width: 30px; font-size: 1.1rem; }

        /* Top Bar */
        .top-bar { 
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); 
            padding: 12px 20px; border-bottom: 1px solid #222; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; 
        }
        .menu-toggle { font-size: 1.4rem; color: var(--cat); cursor: pointer; transition: 0.3s; }

        /* Floating AI Chatbot CSS */
        #ai-chat-btn {
            position: fixed; bottom: 25px; right: 25px; 
            width: 60px; height: 60px; background: var(--cat); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(255, 205, 0, 0.4); cursor: pointer; z-index: 2000;
            transition: 0.3s; border: none;
        }
        #ai-chat-btn:hover { transform: scale(1.1) rotate(15deg); }

        #chat-window {
            position: fixed; bottom: 100px; right: 25px; 
            width: 350px; height: 500px; background: #111; 
            border: 1px solid #333; border-radius: 20px; 
            display: none; flex-direction: column; z-index: 2000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-header { background: #222; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #0a0a0a; display: flex; flex-direction: column; gap: 10px; }
        .chat-footer { padding: 10px; background: #1a1a1a; border-top: 1px solid #333; }
        
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 0.85rem; line-height: 1.4; }
        .msg-ai { background: #222; color: #eee; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: var(--cat); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: 600; }

        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: none; z-index: 1050; }
        .sidebar-overlay.active { display: block; }
        .brand-font { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }
        .neon-text { text-shadow: 0 0 10px rgba(0, 255, 204, 0.5); }

        @media (max-width: 500px) { #chat-window { width: calc(100% - 40px); height: 70vh; right: 20px; } }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="p-4 mb-2">
            <h4 class="brand-font fw-bold text-warning mb-0">DR-MITAMBO</h4>
            <small class="text-white-50 small">PROFESSIONAL OS V10</small>
        </div>
        
        <nav>
            <a href="{{ url_for('index') }}" class="nav-link-pro {% if request.endpoint == 'index' %}active-page{% endif %}">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
            <a href="{{ url_for('diagnosis') }}" class="nav-link-pro {% if request.endpoint == 'diagnosis' %}active-page{% endif %}">
                <i class="fas fa-robot text-info"></i> AI Diagnosis Pro
            </a>
            <a href="{{ url_for('electrical') }}" class="nav-link-pro {% if request.endpoint == 'electrical' %}active-page{% endif %}">
                <i class="fas fa-bolt text-warning"></i> Electrical Hub
            </a>
            <a href="{{ url_for('systems_op') }}" class="nav-link-pro {% if request.endpoint == 'systems_op' %}active-page{% endif %}">
                <i class="fas fa-microchip"></i> Systems Operation
            </a>
            <a href="{{ url_for('troubleshooting') }}" class="nav-link-pro {% if request.endpoint == 'troubleshooting' %}active-page{% endif %}">
                <i class="fas fa-screwdriver-wrench"></i> Troubleshooting
            </a>
            <a href="{{ url_for('maintenance') }}" class="nav-link-pro {% if request.endpoint == 'maintenance' %}active-page{% endif %}">
                <i class="fas fa-calendar-check text-success"></i> Maintenance
            </a>
            <a href="{{ url_for('parts') }}" class="nav-link-pro {% if request.endpoint == 'parts' %}active-page{% endif %}">
                <i class="fas fa-gears"></i> Parts Book
            </a>
            <a href="{{ url_for('manuals') }}" class="nav-link-pro {% if request.endpoint == 'manuals' %}active-page{% endif %}">
                <i class="fas fa-book-open"></i> Service Manuals
            </a>
            <a href="{{ url_for('safety') }}" class="nav-link-pro {% if request.endpoint == 'safety' %}active-page{% endif %}">
                <i class="fas fa-shield-halved text-danger"></i> Safety Module
            </a>
            
            <hr class="mx-3 border-secondary opacity-25">
            <a href="{{ url_for('logout') }}" class="nav-link-pro text-danger mt-3">
                <i class="fas fa-power-off"></i> Logout
            </a>
        </nav>
    </div>

    <div class="main-wrapper">
        <div class="top-bar">
            <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars-staggered"></i></div>
            <div class="brand-font fw-bold small neon-text">DR-MITAMBO <span class="text-warning">PRO</span></div>
            <div class="user-avatar">
                <img src="https://ui-avatars.com/api/?name={{ current_user.username if current_user.is_authenticated else 'User' }}&background=00ffcc&color=000&bold=true" class="rounded-circle border border-secondary" width="35" alt="Profile">
            </div>
        </div>

        <div class="container py-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-dark alert-dismissible fade show border-0 rounded-4 shadow mb-4" role="alert" style="border-left: 5px solid var(--neon) !important;">
                    <i class="fas fa-bell me-2 text-warning"></i> {{ message }}
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </div>
    </div>

    <button id="ai-chat-btn" onclick="toggleChat()">
        <i class="fas fa-comment-dots fa-xl text-dark"></i>
    </button>

    <div id="chat-window">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                <span class="fw-bold small brand-font text-warning">MITAMBO-AI</span>
            </div>
            <button class="btn-close btn-close-white btn-sm" onclick="toggleChat()"></button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="msg msg-ai">
                Habari! Mimi ni msaidizi wako wa <strong>{{ request.endpoint.replace('_', ' ').title() if request.endpoint else 'Mitambo' }}</strong>. 
                Una swali lolote kuhusu sehemu hii?
            </div>
        </div>
        <div class="chat-footer">
            <div class="input-group">
                <input type="text" id="ai-msg-input" class="form-control bg-dark text-white border-0 small" placeholder="Andika swali lako..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-warning btn-sm px-3" onclick="sendChatMsg()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar Logic
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // Chatbot Logic
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendChatMsg(); }

        async function sendChatMsg() {
            const input = document.getElementById('ai-msg-input');
            const body = document.getElementById('chat-body');
            const msg = input.value.trim();
            
            if (!msg) return;

            // Add user message
            body.innerHTML += `<div class="msg msg-user">${msg}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;

            // Loading state
            const loadingId = 'load-' + Date.now();
            body.innerHTML += `<div class="msg msg-ai" id="${loadingId}"><i class="fas fa-spinner fa-spin"></i> Inatafuta majibu...</div>`;
            body.scrollTop = body.scrollHeight;

            try {
                const response = await fetch('/api/ask_expert', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: msg,
                        category: "{{ request.endpoint if request.endpoint else 'general' }}"
                    })
                });
                const data = await response.json();
                document.getElementById(loadingId).innerHTML = data.result;
            } catch (e) {
                document.getElementById(loadingId).innerHTML = "Samahani, nimepata hitilafu. Jaribu tena.";
            }
            body.scrollTop = body.scrollHeight;
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
